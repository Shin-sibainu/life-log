# システムアーキテクチャ

## 概要

LifeLogは、1日の行動・学び・気づきを記録し、AIが活用できる「資産としての日記」サービスです。

## コンポーネント図

```
┌─────────────────────────────────────────────────────────────────┐
│                         クライアント                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │     LP       │  │  ダッシュボード  │  │  分析画面     │          │
│  │  (認証なし)   │  │  (認証必須)     │  │  (認証必須)   │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
│         │                  │                  │                 │
│         └──────────────────┼──────────────────┘                 │
│                            ↓                                    │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │              LocalStorage (未認証時)                      │   │
│  │              - エントリデータ一時保存                       │   │
│  │              - DBスキーマと同一構造                        │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ↓ HTTPS
┌─────────────────────────────────────────────────────────────────┐
│                     Next.js App Router                          │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │                    Route Handlers                         │  │
│  │  /api/auth/*        - BetterAuth認証                      │  │
│  │  /api/v1/*          - MCP用REST API                       │  │
│  │  /api/entries/*     - 内部API                             │  │
│  └──────────────────────────────────────────────────────────┘  │
│                              │                                  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │                    Drizzle ORM                            │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ↓ libsql
┌─────────────────────────────────────────────────────────────────┐
│                     Turso (SQLite Edge)                         │
│  - グローバル分散                                                 │
│  - 低レイテンシ                                                   │
└─────────────────────────────────────────────────────────────────┘

                     ┌─────────────────┐
                     │   MCPクライアント  │
                     │  (Claude等のAI)   │
                     └─────────────────┘
                              │
                              ↓ MCP Protocol
┌─────────────────────────────────────────────────────────────────┐
│                     MCPサーバー                                   │
│  - get_entries: エントリ取得                                      │
│  - search_logs: 全文検索                                         │
│  - get_stats: 統計情報                                           │
│  - get_notes_by_category: カテゴリ別ノート                        │
└─────────────────────────────────────────────────────────────────┘
```

## 技術スタック

| レイヤー | 技術 | 選定理由 |
|----------|------|----------|
| フレームワーク | Next.js 14 (App Router) | RSC対応、フルスタック開発 |
| スタイリング | TASO | 軽量CSS-in-JS |
| 認証 | BetterAuth | Next.js特化、セッション管理簡易 |
| 決済 | Stripe | 業界標準、豊富なドキュメント |
| ORM | Drizzle ORM | 型安全、軽量、SQLite対応 |
| データベース | Turso (SQLite) | Edge対応、低コスト、高速 |
| グラフ | Recharts | React対応、カスタマイズ性 |
| ID生成 | ULID | ソート可能、衝突低確率 |

## データフロー

### 1. 未認証ユーザーの記録フロー

```
1. ユーザーがLPから「今すぐ始める」をクリック
2. エントリ作成画面に遷移
3. To Do、ノート、リンクを入力
4. データをLocalStorageに保存
5. 保存ボタン押下時に認証モーダル表示
6. 認証後、LocalStorageのデータをDBへマイグレーション
7. LocalStorageをクリア
```

### 2. 認証済みユーザーの記録フロー

```
1. ダッシュボードにアクセス
2. 今日のエントリを取得（なければ新規作成）
3. To Do、ノート、リンク、スコアを入力
4. 保存ボタンでAPIを呼び出し
5. DBに永続化
```

### 3. MCP経由のデータアクセス

```
1. AIクライアントがMCPサーバーに接続
2. ユーザーのAPIキーで認証
3. ツール呼び出し（get_entries等）
4. REST API経由でデータ取得
5. 結果をAIに返却
```

## セキュリティ考慮事項

### 認証
- BetterAuthによるセッション管理
- HTTPOnly Cookieでセッション保持
- CSRF対策

### APIキー
- ユーザーごとに発行
- SHA-256でハッシュ化して保存
- レート制限を適用

### データ保護
- HTTPS必須
- 入力値のバリデーション（Zod）
- SQLインジェクション対策（Drizzle ORM）

### CORS
- MCP API用に適切なCORS設定
- 許可オリジンのホワイトリスト

## ディレクトリ構成

```
life-log/
├── app/
│   ├── (auth)/
│   │   ├── login/
│   │   └── signup/
│   ├── (dashboard)/
│   │   ├── layout.tsx
│   │   ├── page.tsx           # 今日のログ
│   │   ├── calendar/
│   │   ├── analytics/
│   │   └── settings/
│   ├── api/
│   │   ├── auth/[...all]/     # BetterAuth
│   │   ├── v1/                # MCP用API
│   │   │   ├── entries/
│   │   │   ├── stats/
│   │   │   ├── categories/
│   │   │   └── notes/
│   │   └── entries/           # 内部API
│   ├── layout.tsx
│   └── page.tsx               # LP
├── components/
│   ├── ui/                    # 共通UIコンポーネント
│   ├── dashboard/             # ダッシュボード用
│   ├── calendar/              # カレンダー用
│   └── charts/                # グラフ用
├── lib/
│   ├── auth.ts                # BetterAuth設定
│   ├── db/
│   │   ├── index.ts           # Drizzle接続
│   │   └── schema.ts          # スキーマ定義
│   ├── api-key.ts             # APIキー管理
│   └── local-storage.ts       # LS操作ユーティリティ
├── hooks/
│   ├── use-entry.ts
│   ├── use-todos.ts
│   └── use-local-storage.ts
├── types/
│   └── index.ts
└── mcp/
    └── server.ts              # MCPサーバー実装
```

## パフォーマンス目標

| 指標 | 目標値 |
|------|--------|
| エントリ取得 | < 100ms |
| ページ初期表示 | < 1.5s (LCP) |
| インタラクション | < 100ms (INP) |
| バンドルサイズ | < 200KB (初期JS) |

## スケーラビリティ

- Tursoのグローバルレプリカで低レイテンシ
- Next.jsのエッジランタイム対応
- 静的ページのISR活用
- APIレート制限で負荷制御
